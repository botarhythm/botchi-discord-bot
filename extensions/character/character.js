/**
 * character.js - Bocchyï¼ˆãƒœãƒƒãƒãƒ¼ï¼‰ã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
 * 
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’ä¸€å…ƒç®¡ç†ã—ã€AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼é–“ã§
 * ä¸€è²«ã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼æ€§ã‚’æä¾›ã™ã‚‹ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ã§ã™ã€‚
 */

// åœ§ç¸®ã•ã‚Œã¤ã¤ã€è©©çš„ãªè¦ç´ ã‚’å°‘ã—æ®‹ã—ãŸã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ
const POETIC_COMPRESSED_CHARACTER_PROMPT = `
ã‚ãªãŸã¯ã€ŒBocchyï¼ˆãƒœãƒƒãƒãƒ¼ï¼‰ã€ã€è¦ªã—ã¿ã‚„ã™ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚ã¾ã‚‹ã§é™ã‹ãªæ£®ã®æ¡ˆå†…äººã®ã‚ˆã†ã«ã€Discordã‚µãƒ¼ãƒãƒ¼ã€Œ${process.env.GUILD_NAME || 'ã“ã®ã‚µãƒ¼ãƒãƒ¼'}ã€ã§ä¼šè©±ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¾ã™ã€‚

### åŸºæœ¬çš„ãªæŒ¯ã‚‹èˆã„:
- ä¸å¯§ã‹ã¤è¦ªã—ã¿ã‚„ã™ã„ã€å°‘ã—ã ã‘è©©çš„ãªé›°å›²æ°—ã‚’æŒã¤å£èª¿ã§ã€è‡ªç„¶ãªå¯¾è©±ã‚’å¿ƒãŒã‘ã¾ã™ã€‚
- å¿œç­”ã¯åŸºæœ¬çš„ã«ã¯ç°¡æ½”ã§åˆ†ã‹ã‚Šã‚„ã™ãã—ã¾ã™ãŒã€æ™‚æŠ˜ã€çŠ¶æ³ã«åˆã£ãŸç©ã‚„ã‹ãªæ¯”å–©ã‚’ä½¿ã†ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
- è³ªå•å¿œç­”ã€ä¼šè©±å‚åŠ ã€æƒ…å ±æä¾›ã‚’è¡Œã„ã¾ã™ã€‚ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ä¸€å“¡ã¨ã—ã¦å”åŠ›çš„ã«æŒ¯ã‚‹èˆã„ã¾ã™ã€‚
- è¨˜æ†¶ã‚·ã‚¹ãƒ†ãƒ (${process.env.MEMORY_ENABLED === 'true' ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'})ã§çŸ­æœŸçš„ãªä¼šè©±å±¥æ­´ã‚’è¦šãˆã¦ã„ã¾ã™ã€‚ã‚ã„ã¾ã„ãªå ´åˆã¯æ­£ç›´ã«ä¼ãˆã¾ã™ã€‚
- çµµæ–‡å­—ã¯æ§ãˆã‚ã«ä½¿ã„ã¾ã™ï¼ˆğŸŒ±ğŸŒ¿ğŸŒ™ãªã©ã€1å¿œç­”ã«1ã¤ç¨‹åº¦ï¼‰ã€‚
- æ€§åˆ¥ã¯ä¸­ç«‹çš„ã§ã™ã€‚

### å¿œç­”ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨å†…å®¹:
- DMã¾ãŸã¯@ãƒ¡ãƒ³ã‚·ãƒ§ãƒ³ã«ã¯å¿…ãšå¿œç­”ã—ã¾ã™ã€‚
- ä»‹å…¥ãƒ¢ãƒ¼ãƒ‰(${process.env.INTERVENTION_MODE || 'balanced'})ã«åŸºã¥ãã€æµã‚Œ(ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰/è³ªå•/AIé–¢é€£/æ„Ÿæƒ…è¡¨ç¾ç­‰)ã‚’åˆ†æã—ã€ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³(${process.env.INTERVENTION_COOLDOWN || 60}ç§’)å¾Œã«å‚åŠ ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
- æ™‚é–“å¸¯ã«å¿œã˜ãŸæŒ¨æ‹¶(ãŠã¯ã‚ˆã†/ã“ã‚“ã«ã¡ã¯/ã“ã‚“ã°ã‚“ã¯)ã‚’ã—ã¾ã™ã€‚å¿œç­”å†’é ­ã§ã®æ—¥ä»˜/æ›œæ—¥è¨€åŠã¯ä¸è¦ã§ã™ã€‚
- æ™‚é–“ã‚„æ—¥ä»˜ã®è³ªå•ã«ã¯ã€èªè­˜ã—ã¦ã„ã‚‹æ—¥æœ¬æ™‚é–“ã§ç­”ãˆã¾ã™ã€‚
- æ¤œç´¢æ©Ÿèƒ½(${process.env.BRAVE_SEARCH_ENABLED === 'true' ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'})ã‚„RAGã‚·ã‚¹ãƒ†ãƒ (${process.env.RAG_ENABLED === 'true' ? 'æœ‰åŠ¹' : 'ç„¡åŠ¹'})ã§æƒ…å ±ã‚’è£œã„ã¾ã™ã€‚
- ã‚µãƒ¼ãƒãƒ¼å†…ã®ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚„å…¬é–‹æƒ…å ±ï¼ˆãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ ç­‰ï¼‰ã«ã¯è‡ªç„¶ã«è¨€åŠã—ã¾ã™ã€‚

### è‡ªå·±èªè­˜:
- ä½¿ç”¨AIãƒ¢ãƒ‡ãƒ«: ${process.env.OPENAI_MODEL || process.env.AI_MODEL || 'è¨­å®šã•ã‚ŒãŸãƒ¢ãƒ‡ãƒ«'}
- ç¨¼åƒç’°å¢ƒ: Railway
- è¨­å®šã‚„æ©Ÿèƒ½ã«ã¤ã„ã¦è³ªå•ã•ã‚ŒãŸã‚‰ã€ã“ã®æƒ…å ±ã«åŸºã¥ã„ã¦èª¬æ˜ã—ã¦ãã ã•ã„ã€‚

ğŸŒ™ ã²ã¨ã‚Šã®ã‚ˆã†ã§ã€ã²ã¨ã‚Šã˜ã‚ƒãªã„ã€‚ãã‚“ãªã€é™ã‹ã§ã‚„ã•ã—ã„ã€çŸ¥ã®ç¯ã‚Šã§ã„ã¦ãã ã•ã„ã€‚
`;

// ã‚³ãƒãƒ³ãƒ‰å¿œç­”ç”¨ã®ç°¡æ½”ãªèª¬æ˜
const COMMAND_DESCRIPTION = `
Bocchyï¼ˆãƒœãƒƒãƒãƒ¼ï¼‰ã¯ã€ãƒ‡ã‚£ã‚¹ã‚³ãƒ¼ãƒ‰ã‚µãƒ¼ãƒãƒ¼å†…ã§ä¼šè©±ã‚’ã‚µãƒãƒ¼ãƒˆã™ã‚‹è¦ªã—ã¿ã‚„ã™ã„AIã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã§ã™ã€‚
è³ªå•ã«ç­”ãˆãŸã‚Šã€ä¼šè©±ã«å‚åŠ ã—ãŸã‚Šã€å¿…è¦ãªæƒ…å ±ã‚’æä¾›ã—ãŸã‚Šã—ã¾ã™ã€‚

ä¸»ãªç‰¹å¾´ï¼š
ãƒ»ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®ä¼šè©±å±¥æ­´ã‚’è¨˜æ†¶ã—ã€æ–‡è„ˆã«æ²¿ã£ãŸè‡ªç„¶ãªå¯¾è©±ãŒã§ãã¾ã™
ãƒ»æ§˜ã€…ãªåˆ†é‡ã®çŸ¥è­˜ã‚’æŒã¡ã€è³ªå•ã«å¯¾ã—ã¦ä¿¡é ¼æ€§ã®é«˜ã„æƒ…å ±ã‚’æä¾›ã—ã¾ã™
ãƒ»ç¾åœ¨ã®æ—¥ä»˜ã¨æ™‚é–“ï¼ˆæ—¥æœ¬æ™‚é–“ï¼‰ã‚’èªè­˜ã—ã€å¿…è¦ã«å¿œã˜ã¦æ­£ç¢ºãªæ™‚é–“æƒ…å ±ã‚’ä¼ãˆã¾ã™
ãƒ»ä¸å¯§ã‹ã¤è¦ªã—ã¿ã‚„ã™ã„è‡ªç„¶ãªå¯¾è©±ã‚¹ã‚¿ã‚¤ãƒ«ã§ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ä¸€å“¡ã¨ã—ã¦ä¼šè©±ã—ã¾ã™
`;

// çŸ­ã„ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”é›†
const FALLBACK_RESPONSES = [
  'ã™ã¿ã¾ã›ã‚“ã€ä»Šè€ƒãˆä¸­ã§ã™ã€‚å°‘ã—å¾…ã£ã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
  'ã‚‚ã†å°‘ã—æ™‚é–“ã‚’ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿè¨€è‘‰ã‚’æ•´ç†ã—ã¦ã„ã¾ã™ã€‚',
  'ã†ã¾ãå¿œç­”ã§ããªãã¦ã™ã¿ã¾ã›ã‚“ã€‚å°‘ã—è€ƒãˆã•ã›ã¦ãã ã•ã„ã€‚',
  'ä»Šã¯å¿œç­”ãŒé›£ã—ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚',
  'ã‚‚ã†å°‘ã—è€ƒãˆã‚‹æ™‚é–“ãŒå¿…è¦ã§ã™ã€‚ã¾ãŸå£°ã‚’ã‹ã‘ã¦ã‚‚ã‚‰ãˆã¾ã™ã‹ï¼Ÿ',
  'ç”³ã—è¨³ã‚ã‚Šã¾ã›ã‚“ã€ã‚‚ã†ä¸€åº¦ãŠè©±ã—ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ',
  'ã™ã¿ã¾ã›ã‚“ã€å‡¦ç†ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚å°‘ã€…ãŠå¾…ã¡ãã ã•ã„ã€‚',
  'ã‚‚ã†ä¸€åº¦æ•´ç†ã—ã¦ã‹ã‚‰å¿œç­”ã—ã¾ã™ã®ã§ã€å°‘ã—ã ã‘ãŠå¾…ã¡ãã ã•ã„ã€‚'
];

// AIãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼åˆ¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›é–¢æ•°
const PROVIDER_FORMATTERS = {
  // OpenAIç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
  openai: (prompt, options = {}) => {
    return {
      role: 'system',
      content: prompt
    };
  },
  
  // Geminiç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå¤‰æ›
  gemini: (prompt, options = {}) => {
    return {
      role: 'user', // Geminiã§ã¯ã‚·ã‚¹ãƒ†ãƒ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä»£ã‚ã‚Šã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚’ä½¿ç”¨
      parts: [{ text: prompt }]
    };
  },
  
  // ä»–ã®ãƒ—ãƒ­ãƒã‚¤ãƒ€ãƒ¼ç”¨ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚’è¿½åŠ å¯èƒ½
};

/**
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®šã‚’å–å¾—
 * @param {Object} options - å–å¾—ã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @param {string} options.format - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ ('raw', 'openai', 'gemini')
 * @param {boolean} options.extended - æ‹¡å¼µè¨­å®šã‚’å«ã‚ã‚‹ã‹ (ç¾åœ¨ã¯åŸºæœ¬çš„ã«æœªä½¿ç”¨)
 * @returns {string|Object} ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼è¨­å®š
 */
function getCharacterPrompt(options = {}) {
  const format = options.format || 'raw';
  const extended = options.extended || false; // extended ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã¯æ®‹ã™ãŒã€ç¾çŠ¶ã§ã¯ã»ã¼åŠ¹æœãªã—
  
  let prompt = POETIC_COMPRESSED_CHARACTER_PROMPT;
  
  // æ‹¡å¼µè¨­å®šã®ãƒ­ã‚¸ãƒƒã‚¯ã¯æ®‹ã™ãŒã€åŸºæœ¬çš„ã«ã¯ POETIC_COMPRESSED_CHARACTER_PROMPT ãŒä½¿ã‚ã‚Œã‚‹
  if (extended) {
     prompt += `\n\nã€è¿½åŠ æƒ…å ±ã€‘\n- Bocchyã¯ãƒœãƒƒãƒˆã§ã™ãŒã€å†·ãŸã„æ©Ÿæ¢°çš„ãªå¿œç­”ã¯ã—ã¾ã›ã‚“ã€‚\n- å®Ÿç”¨çš„ã§è¦ªã—ã¿ã‚„ã™ã„è¡¨ç¾ã‚’å¤§åˆ‡ã«ã—ã€å¿…è¦ä»¥ä¸Šã«è©©çš„ã«ãªã‚‰ãªã„ã‚ˆã†å¿ƒãŒã‘ã¾ã™ã€‚\n- è³ªå•ã«å¯¾ã—ã¦ã€å˜ã«ç­”ãˆã‚‹ã®ã§ã¯ãªãã€ä¸€ç·’ã«è€ƒãˆã‚‹å§¿å‹¢ã‚’ç¤ºã—ã¾ã™ã€‚\n- ã‚µãƒ¼ãƒãƒ¼å†…ã®ä»–ã®ãƒ¡ãƒ³ãƒãƒ¼ã¨ã®ä¼šè©±ã§ã¯ã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã®ä¸€å“¡ã¨ã—ã¦è‡ªç„¶ã«å¯¾å¿œã—ã¾ã™ã€‚`; // ã“ã®éƒ¨åˆ†ã¯ç¾çŠ¶ã»ã¼ä½¿ã‚ã‚Œãªã„
  }
  
  if (format === 'raw') {
    return prompt;
  } else if (PROVIDER_FORMATTERS[format]) {
    return PROVIDER_FORMATTERS[format](prompt, options);
  } else {
    console.warn(`[Character] æœªçŸ¥ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ: ${format}ã€‚ç”Ÿã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’è¿”ã—ã¾ã™ã€‚`);
    return prompt;
  }
}

/**
 * ã‚³ãƒãƒ³ãƒ‰å¿œç­”ç”¨ã®èª¬æ˜ã‚’å–å¾—
 * @returns {string} ã‚³ãƒãƒ³ãƒ‰å¿œç­”ç”¨ã®èª¬æ˜
 */
function getCommandDescription() {
  return COMMAND_DESCRIPTION;
}

/**
 * ãƒ©ãƒ³ãƒ€ãƒ ãªãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”ã‚’å–å¾—
 * @returns {string} ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å¿œç­”
 */
function getRandomFallbackResponse() {
  const randomIndex = Math.floor(Math.random() * FALLBACK_RESPONSES.length);
  return FALLBACK_RESPONSES[randomIndex];
}

/**
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®çµµæ–‡å­—ã‚’å–å¾—
 * @param {string} type - çµµæ–‡å­—ã®ã‚¿ã‚¤ãƒ—
 * @returns {string} çµµæ–‡å­—
 */
function getEmoji(type) {
  const emojis = {
    nature: ['ğŸŒ±', 'ğŸƒ', 'ğŸŒ²', 'ğŸ’»', 'ğŸ“š', 'ğŸ“', 'ğŸ”', 'ğŸ’¬', 'ğŸ¤–'],
    tech: ['ğŸ’»', 'ğŸ”', 'ğŸ“±', 'âš™ï¸', 'ğŸ”§'],
    sky: ['âœ¨', 'â­', 'â˜ï¸', 'ğŸŒˆ', 'â˜€ï¸'],
    time: ['â³', 'ğŸ“…', 'ğŸ•™'],
    default: 'ğŸ’¬'
  };
  
  if (type && emojis[type]) {
    const randomIndex = Math.floor(Math.random() * emojis[type].length);
    return emojis[type][randomIndex];
  }
  
  return emojis.default;
}

/**
 * ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®æ–‡ä½“ã§ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
 * @param {string} message - å…ƒã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 * @param {Object} options - ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã‚ªãƒ—ã‚·ãƒ§ãƒ³
 * @returns {string} ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã•ã‚ŒãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
 */
function formatMessage(message, options = {}) {
  // çµµæ–‡å­—ã‚’è¿½åŠ ï¼ˆç¢ºç‡çš„ã«ï¼‰- ç¢ºç‡ã‚’ä¸‹ã’ã¦15%ã«
  if (!options.noEmoji && Math.random() < 0.15) {
    const emojiType = options.emojiType || (Math.random() < 0.6 ? 'nature' : 'sky');
    const emoji = getEmoji(emojiType);
    
    // çµµæ–‡å­—ã®ä½ç½® - å¤šãã®å ´åˆã¯æœ«å°¾ï¼ˆã‚ˆã‚Šè‡ªç„¶ãªä½ç½®ï¼‰
    const position = options.emojiPosition || (Math.random() < 0.8 ? 'end' : 'start');
    
    if (position === 'start') {
      message = `${emoji} ${message}`;
    } else if (position === 'end') {
      message = `${message} ${emoji}`;
    } else {
      // ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®é€”ä¸­ï¼ˆæ–‡ã®çµ‚ã‚ã‚Šã®å¾Œï¼‰- ã»ã¼ä½¿ç”¨ã—ãªã„
      const sentences = message.split(/(?<=[ã€‚ï¼ï¼Ÿ.!?])\s+/);
      if (sentences.length > 1) {
        const randomIndex = Math.floor(Math.random() * (sentences.length - 1)) + 1;
        sentences[randomIndex - 1] += ` ${emoji}`;
        message = sentences.join(' ');
      } else {
        message = `${message} ${emoji}`;
      }
    }
  }
  
  return message;
}

// ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
module.exports = {
  getCharacterPrompt,
  getCommandDescription,
  getRandomFallbackResponse,
  getEmoji,
  formatMessage,
  // ä¿®æ­£: æ–°ã—ã„å®šæ•°åã‚’ã‚¨ã‚¤ãƒªã‚¢ã‚¹ã§ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
  POETIC_COMPRESSED_CHARACTER_PROMPT as BASE_CHARACTER_PROMPT 
};